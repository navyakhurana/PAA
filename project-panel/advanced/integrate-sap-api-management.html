<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-project-panel/advanced/integrate-sap-api-management/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Integrate SAP API Management | Build resilient apps with SAP BTP</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://navyakhurana.github.io/PAA/project-panel/advanced/integrate-sap-api-management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Integrate SAP API Management | Build resilient apps with SAP BTP"><meta data-rh="true" name="description" content="As your SaaS application contains an API that allows your Subscriber to interact programmatically with their Tenant database containers, you need to ensure that your API endpoints are properly managed and monitored. For this purpose, you should implement features like Rate Limiting to prevent DoS attacks. Furthermore, you can ensure fair usage of the resources among your consumers by setting up a Quota based on the chosen service plan. A premium Subscriber can be eligible to send more requests per second than a standard Consumer. Proper monitoring of your API will help you analyze performance issues and to identify problems of your consumers."><meta data-rh="true" property="og:description" content="As your SaaS application contains an API that allows your Subscriber to interact programmatically with their Tenant database containers, you need to ensure that your API endpoints are properly managed and monitored. For this purpose, you should implement features like Rate Limiting to prevent DoS attacks. Furthermore, you can ensure fair usage of the resources among your consumers by setting up a Quota based on the chosen service plan. A premium Subscriber can be eligible to send more requests per second than a standard Consumer. Proper monitoring of your API will help you analyze performance issues and to identify problems of your consumers."><link data-rh="true" rel="icon" href="/PAA/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://navyakhurana.github.io/PAA/project-panel/advanced/integrate-sap-api-management"><link data-rh="true" rel="alternate" href="https://navyakhurana.github.io/PAA/project-panel/advanced/integrate-sap-api-management" hreflang="en"><link data-rh="true" rel="alternate" href="https://navyakhurana.github.io/PAA/project-panel/advanced/integrate-sap-api-management" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://SX6JA1B3F5-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Build resilient apps with SAP BTP" href="/PAA/opensearch.xml">

<script src="js/custom.js" async></script><link rel="stylesheet" href="/PAA/assets/css/styles.f9497dcc.css">
<link rel="preload" href="/PAA/assets/js/runtime~main.f3fc8105.js" as="script">
<link rel="preload" href="/PAA/assets/js/main.7d67572a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/PAA/"><div class="navbar__logo"><img src="/PAA/img/githubFolder.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/PAA/img/githubFolder.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Develop a multitenant Software as a Service application in SAP BTP using CAP</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/SAP-samples/btp-kyma-cap-multitenant-susaas" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/PAA/">OVERVIEW</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/PAA/category/project-panel">PROJECT PANEL</a><button aria-label="Toggle the collapsible sidebar category &#x27;PROJECT PANEL&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/PAA/category/discover">Discover</a><button aria-label="Toggle the collapsible sidebar category &#x27;Discover&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/PAA/category/basic">Basic</a><button aria-label="Toggle the collapsible sidebar category &#x27;Basic&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/PAA/category/advanced">Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PAA/project-panel/advanced/introduction-advanced-version">Advanced Version Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PAA/project-panel/advanced/understand-repo-details">Advanced Version Repository details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PAA/project-panel/advanced/prepare-provider-subaccount">Prepare the Provider Subaccount</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PAA/project-panel/advanced/central-user-management-ias">Central user management using SAP Identity Authentication Service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PAA/project-panel/advanced/push-data-s4hana-system">Push data from SAP S/4HANA system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/PAA/project-panel/advanced/integrate-sap-api-management">Integrate SAP API Management</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/PAA/category/expert">Expert</a><button aria-label="Toggle the collapsible sidebar category &#x27;Expert&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/PAA/support">SUPPORT</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/PAA/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/PAA/category/project-panel"><span itemprop="name">PROJECT PANEL</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/PAA/category/advanced"><span itemprop="name">Advanced</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Integrate SAP API Management</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Integrate SAP API Management</h1><p>As your SaaS application contains an API that allows your Subscriber to interact programmatically with their Tenant database containers, you need to ensure that your API endpoints are properly managed and monitored. For this purpose, you should implement features like <strong>Rate Limiting</strong> to prevent DoS attacks. Furthermore, you can ensure fair usage of the resources among your consumers by setting up a <strong>Quota</strong> based on the chosen service plan. A premium Subscriber can be eligible to send more requests per second than a standard Consumer. Proper monitoring of your API will help you analyze performance issues and to identify problems of your consumers. </p><p>In this part of the tutorial, you will learn how to ensure that each and every request targeting your SaaS API is passing through SAP API Management first. SAP API Management (as part of SAP Integration Suite), is SAP&#x27;s standard cloud software offering for all API-related requirements. </p><ul><li><a href="#integrate-sap-api-management">Integrate SAP API Management</a><ul><li><a href="#1-architecture">1. Architecture</a></li><li><a href="#2-prerequisites">2. Prerequisites</a></li><li><a href="#3-integration-setup">3. Integration Setup</a></li><li><a href="#4-under-the-hood">4. Under the hood</a></li><li><a href="#5-api-policy-deep-dive">5. API Policy Deep Dive</a><ul><li><a href="#51-decode-jwt-token-policy">5.1. Decode JWT Token Policy</a></li><li><a href="#52-spike-arrest-policy">5.2. Spike Arrest Policy</a></li><li><a href="#53-api-quota-policies">5.3. API Quota Policies</a></li><li><a href="#54-kyma-authentication-policies">5.4. Kyma Authentication Policies</a></li><li><a href="#55-statistics-collection-policies">5.5. Statistics Collection Policies</a></li><li><a href="#56-update-api-proxy-and-deploy-changes">5.6. Update API Proxy and deploy changes</a></li></ul></li><li><a href="#6-test-the-setup">6. Test the setup</a></li><li><a href="#7-further-information">7. Further Information</a></li></ul></li></ul><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span><mdxadmonitiontitle><strong>Important</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>SAP API Management limits the payload size of a single HTTP request to 10 MB for non-streamed HTTP requests and responses (<a href="https://me.sap.com/notes/0003087398" target="_blank" rel="noopener noreferrer">see details</a>). If you want to transfer larger files, please consider streaming! </p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-architecture">1. Architecture<a href="#1-architecture" class="hash-link" aria-label="Direct link to 1. Architecture" title="Direct link to 1. Architecture">​</a></h2><p>SAP API Management is a new component in the central part of the <strong>Advanced Version</strong> architecture. While in the Basic Version, the API calls were directly accessing the Kyma API Service workloads, now all requests are passing through this additional component, giving you great flexibility in how to handle your in and outbound API traffic. See the relevant part of the solution architecture below (click to enlarge):</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Architecture.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Architecture-f0a9a0a06de187d3c6d6be2fe2e58bba.png" width="1128" height="768" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-prerequisites">2. Prerequisites<a href="#2-prerequisites" class="hash-link" aria-label="Direct link to 2. Prerequisites" title="Direct link to 2. Prerequisites">​</a></h2><p>For this setup, please make sure you have an SAP API Management tenant up and running. As SAP API Management is a capability of <strong>SAP Integration Suite</strong>, please subscribe to SAP Integration Suite and activate the respective <strong>API Management</strong> feature. Check the following SAP Help documentation to find a detailed step-by-step guide (<a href="https://help.sap.com/docs/SAP_CLOUD_PLATFORM_API_MANAGEMENT/66d066d903c2473f81ec33acfe2ccdb4/f6eb4332cd5144ef91f4a84cc614ba1c.html?locale=en-US" target="_blank" rel="noopener noreferrer">click here</a>). As part of this documentation, we cannot provide additional details on the setup process of SAP Integration Suite. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_IntegrationSuite.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_IntegrationSuite-7f11fab3cb9072a04c13b9b47202764e.png" width="1254" height="723" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-integration-setup">3. Integration Setup<a href="#3-integration-setup" class="hash-link" aria-label="Direct link to 3. Integration Setup" title="Direct link to 3. Integration Setup">​</a></h2><p>While Cloud Foundry offers a very convenient integration option using so-called <strong>Route Services</strong> (directly intercepting the traffic targeting your API), in Kyma we need to setup the necessary routing ourself. As already covered in the introductory Kyma chapters (<a href="/PAA/project-panel/basic/kyma-resources-helm">see here</a>), any request targeting our Kyma API Service is initially routed to <strong>SAP API Management</strong>, where relevant API Rules (Rate Limiting, Quotas) are being checked. Only if those rules are passed, the traffic is send back to Kyma and routed to the actual API Service workloads. The relevant SAP API Management instance details for this routing have to be maintained in the <em>values.yaml</em> file of the Umbrella Helm Chart. </p><p>3.1. Below you can see a sample-configuration, containing all details required for the integration on the Kyma side. Please update your Umbrella Helm Chart <em>values.yaml</em> file accordingly. The required Secret <strong>\&lt;ReleaseName<!-- -->&gt;<!-- -->-api-xsuaa-apim</strong> (bearing the required config details) will already exist in your Kyma namespace, even if SAP API Management Integration was disabled during the initial Helm deployment. </p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">api</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">bindings</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">xsuaa-api</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceInstanceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xsuaa</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sm-container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceInstanceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceKeys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Service Key to be used by SAP API Management</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Creates Secret &quot;&lt;ReleaseName&gt;-api-xsuaa-apim&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">xsuaa-apim</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceInstanceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xsuaa</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/susaas</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apim</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Enable SAP API Management Integration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># SAP API Management Runtime Host (without https://)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;SubaccountSubdomain</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">.prod.apimanagement.&lt;SubaccountRegion</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">.hana.ondemand.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># SAP API Management Runtime Port (default - 443)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># SAP API Management API Proxy Path (default - kyma-api-susaas)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kyma</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">susaas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Details of the API XSUAA SAP BTP Service Instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Values can also be found in your &quot;&lt;ReleaseName&gt;-api-xsuaa-apim&quot; Secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">xsuaa</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Provide the XSUAA tenant URL of Provider Subaccount (without https://)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;url&quot; property of your &quot;&lt;ReleaseName&gt;-api-xsuaa-apim&quot; Secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;SubaccountSubdomain</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">.authentication.&lt;SubaccountRegion</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">.hana.ondemand.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Provide the Client ID of your API XSUAA Service Instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;clientid&quot; property of your &quot;&lt;ReleaseName&gt;-api-xsuaa-apim&quot; Secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Only provide the string value to the left of the exclamation mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sub</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&lt;ReleaseName</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&lt;Namespace</span><span class="token punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Below you can see a screenshot of a sample Secret with the required values highlighted. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_SecretDetails.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_SecretDetails-aa50f31aa5f0d02e132e5147beb61104.png" width="1314" height="939" class="img_ev3q"></p><p>3.2. After <strong>enabling</strong> the integration scenario in your <strong>values.yaml</strong> file, run another <strong>helm upgrade</strong> to apply the changes.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade &lt;ReleaseName&gt; ./charts/sustainable-saas -n &lt;Namespace&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3.3. Switch to <strong>SAP API Management</strong> to configure the missing integration parts and to upload our <strong>sample API Proxy</strong>. </p><p>3.4. First of all, you need to store the respective XSUAA Client Credentials (part of the mentioned Kyma Secret) in SAP API Management. To do so, please open the <strong>Configure</strong> menu and select <strong>APIs</strong>. Switch to the <strong>Key Value Maps</strong> tab and click on <strong>Create</strong>.</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_KeyValue01.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_KeyValue01-78d0770e9fbc57016e30f32434c3d559.png" width="1311" height="395" class="img_ev3q"></p><p>3.5. Create a new Key Value Map named <strong>susaas-api</strong> containing the <strong>Client Id</strong> and <strong>Token Endpoint</strong> of your XSUAA Service Instance. You can find the required details in your <strong>\&lt;ReleaseName<!-- -->&gt;<!-- -->-api-xsuaa-apim</strong> Kyma Secret. <strong>Save</strong> the Key Value Map. </p><ul><li><p>clientId: <strong>clientid</strong> property of Kyma Secret</p><blockquote><p>Example -&gt; sb-susaas-api-default!b1234</p></blockquote></li><li><p>tokenEndpoint: <strong>url</strong> property of Kyma Secret (<strong>without https://</strong>)</p><blockquote><p>Example -&gt; sap-demo.authentication.us20.hana.ondemand.com</p></blockquote><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_KeyValue02.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_KeyValue02-94bb7dbb694b925a3c0a24c643e055af.png" width="1057" height="411" class="img_ev3q"></p></li></ul><p>3.6. Create a second <strong>Key Value Map</strong> named <strong>susaas-api-key</strong> containing the <strong>Client Secret</strong> of your XSUAA Service Instance. Enable encryption for this Key Value Map before you save it. </p><ul><li><p>clientSecret : <strong>clientsecret</strong> property of Kyma Secret</p><blockquote><p>Example -&gt; ac4f13bc-a1b2-c3d4-e5f6-38e067544oayNBjvt=</p></blockquote><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_KeyValue03.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_KeyValue03-c13679ca9feaf17b4edd80ac807a538a.png" width="1057" height="418" class="img_ev3q"></p></li></ul><p>3.7. As the provided sample <strong>API Proxy</strong> contains an additional monitoring features (like tracking the XSUAA Zone ID of the client as well as the requested OData entity), please add those additional <strong>Dimensions</strong> in the <strong>Monitoring</strong> section of your SAP API Management instance. Therefore, please switch to the <strong>APIs</strong> section of the <strong>Monitoring</strong> menu and click on <strong>+ Add</strong>.</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Dimensions01.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Dimensions01-8badabf083827a8295b27cde0522ffb9.png" width="1515" height="562" class="img_ev3q"></p><p>3.8. Create the following three <strong>Dimensions</strong>, which are being used by the sample API Proxy. Click on <strong>OK</strong> to save the changes.</p><ul><li><p>ODataEntityList</p></li><li><p>ODataPrimaryEntity</p></li><li><p>Zone</p><p><img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Dimensions02.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Dimensions02-40fcc3b01e5f3e53d17baf37d4144e6d.png" width="1519" height="774" class="img_ev3q"></p></li></ul><p>3.9. Return to the <strong>Design</strong> environment and upload the provided sample <strong>APIProxy.zip</strong> file, which you can find in the <strong>files</strong> subfolder (<a href="/PAA/project-panel/advanced/files">click here</a>) of this tutorial.</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Upload01.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Upload01-2f85fb294cde1fab991cc2e052a2e65a.png" width="1334" height="565" class="img_ev3q">
<img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Upload02.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Upload02-492a0446ce38f37399a1c809b023f025.png" width="1335" height="602" class="img_ev3q"></p><p>3.10. Once uploaded, please open the susaas-api <strong>API Proxy</strong> definition and update the <strong>Target Endpoint</strong> with your Kyma API Service URI (e.g., susaas-api-default.a1b2c3d4.kyma.ondemand.com) as you can see in the following screenshots. </p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><strong>Hint</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>If you are using a <strong>custom domain</strong> in your Kyma environment, please also use in this context (e.g., susaas-api-default.sap-demo.com).</p></div></div><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy01.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy01-8b37132df4b79c8406631c631e9f1827.png" width="1332" height="454" class="img_ev3q">
<img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy03.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy03-476991fcb381658920d118772d689778.png" width="1334" height="477" class="img_ev3q"></p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy04.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy04-98dbe69752583fa41365525f8df77f0b.png" width="1335" height="480" class="img_ev3q">
<img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy05.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy05-e163559795845311d2ea5dc0ff8b31bf.png" width="1336" height="490" class="img_ev3q"></p><p>3.11. Save your changes and deploy the <strong>API Proxy</strong> as shown in the following screenshots. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy06.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy06-e7798e85d034afe08db831e6b8a1251d.png" width="1337" height="507" class="img_ev3q">
<img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy07.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy07-c0d0476fa381203008f69de59c9cf72e.png" width="1336" height="588" class="img_ev3q"></p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Proxy08.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Proxy08-420ecf9a2b408581659444bccf94af05.png" width="1336" height="533" class="img_ev3q"></p><p>This is it - From now on, all requests targeting your Kyma API Service workloads will be routed through SAP API Management to enforce policies like <strong>Rate Limiting</strong> or <strong>Quotas</strong>. If the policies checks are passed, the request is returning to Kyma and is served by our API Service <strong>Target Endpoint</strong>. In the next chapter, we will provide you with a sneak peak of what is happening under the hood of this architecture.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-under-the-hood">4. Under the hood<a href="#4-under-the-hood" class="hash-link" aria-label="Direct link to 4. Under the hood" title="Direct link to 4. Under the hood">​</a></h2><p>As briefly touched in our <a href="/PAA/project-panel/basic/kyma-resources-helm/components/TemplateDetails">Template Details</a> chapter, we make use of dedicated Istio resources to accomplish this integration path. Let us summarize the respective flow once again, so you get an idea of what&#x27;s happening under the hood. As this approach can also be applied for any other kind of external service apart from SAP API Management, make sure you understand the basic concept. This will allow you a similar integration with iFlows of SAP Integration Suite. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_KymaRouting.png&amp;quot; width=&amp;quot;700&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_KymaRouting-dfeff21931d13dacdb290f1bbed61463.png" width="1362" height="734" class="img_ev3q"></p><p>The general target should be clear by now. We need to ensure that no request can reach our Kyma API Service without passing through the policy checks in SAP API Management. As visualized above, respective Istio resources ensure, that a valid JWT token is part of any incoming request (<strong>x-jwt-assertion</strong> custom header). This JWT token header, is the core component of this integration, and is generated and injected by SAP API Management (see details in <a href="#5-api-policy-deep-dive">API Policy Deep Dive</a>), based on dedicated Client Credentials of an XSUAA service instance.  </p><p>That summary already gave you a glimpse of an idea how things will gear into each other? Excellent! Let&#x27;s tackle one step after the other! </p><ul><li>Everything starts with an API request arriving in our Kyma Cluster through the <strong>Istio Ingress Gateway</strong>. While you can also provide your Tenants the API Proxy endpoints, we decided to leverage the additional flexibility offered by Istio when it comes to an end-to-end routing scenario.</li></ul><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span><mdxadmonitiontitle><strong>Important</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>The additional hop from Kyma to SAP API Management will result in slightly longer response times, so if your use-case targets minimal response times, you might think about equipping your subscribers with the API Proxy endpoints. If your scenario is all about latency and you are transferring huge loads through the API endpoints, you might also think about API Rule checks as part of your API Service implementation or leveraging Istio features for Rate Limiting.   </p></div></div><ul><li>To integrate <strong>SAP API Management</strong> with our Service Mesh, a dedicated <strong>Istio Virtual Service</strong> is used. This Virtual Service defines routing rules for all requests arriving for our API Service through <strong>Istio Ingress Gateway</strong>. The routing rules are based on the availability of the custom <strong>x-jwt-assertion</strong> header. If the header is missing (initial request), traffic is routed to the SAP API Management API Proxy. If the custom header is part of the request, traffic is routed to our Kyma API Service. </li></ul><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span><mdxadmonitiontitle><strong>Important</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>The <strong>x-jwt-assertion</strong> custom header is injected by SAP API Management, once the request has successfully passed all Traffic Policies (like Rate Limiting).</p></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Matches all requests arriving on host exposed by SusaaS API Service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gateways</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> kyma</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system/kyma</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> susaas</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">default.a1b2c3d4.kyma.ondemand.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Matches requests containing the x-jwt-assertion header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">x-jwt-assertion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Routes requests to Cluster IP Service of our SaaS API </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> susaas</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Matches requests without the x-jwt-assertion header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">withoutHeaders</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">x-jwt-assertion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Rewrite URL path to add API Proxy path and authority details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">rewrite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /susaas</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">authority</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.prod.apimanagement.us20.hana.ondemand.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Routes to SAP API Management defined in the Service Entry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.prod.apimanagement.us20.hana.ondemand.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p><strong>Side note</strong> - A so-called <strong>Service Entry</strong> makes SAP API Management known as a mesh-external service. This allows us to it as destination in Virtual Services routing rules. </p></blockquote><ul><li>Once a request has successfully passed all Policies in SAP API Management, the API Proxy will request a new JWT <strong>access token</strong> using XSUAA Client Credentials, which are securely stored in respective Key Value Maps. Those have already been set up by you in the introduction of this tutorial. Only SAP API Management is in possession of those Client Credentials, so no Tenant will ever be able to generate a valid access token himself. By checking the validity of this JWT token (passed in the x-jwt-assertion header), you can ensure, that a request has successfully passed through SAP API Management. The request incl. the custom header is finally send back to Kyma. </li></ul><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span><mdxadmonitiontitle><strong>Important</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>Your SaaS subscribers nor any other person should never get access to those Client Credentials. Also make sure to rotate them on a regular basis. </p></div></div><p>As a smart and knowledgeable security enthusiast, you will probably wonder about the following question... &quot;Well, the routing based on a custom header is nice, but does it protect me from anyone just adding the respective custom header manually to the request?!&quot; You are absolutely right and this would bypass the routing to SAP API Management... but no worries, our API Service wouldn&#x27;t budge an inch, as the probability of generating a valid JWT token is close to zero. Read along, to learn how the token validation is implemented in Kyma using various Istio components. </p><ul><li>First of all, an Istio <strong>Request Authentication</strong> checks, whether a request targeting the API Service provides a <strong>valid</strong> JWT token in the <strong>x-jwt-assertion</strong> header, which is issued by a trusted issuer. If this is the case, the request is <strong>considered authenticated</strong> and respective <strong>identity details</strong> can be used by subsequent authorization checks in Authorization Policies. </li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><strong>Hint</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>A standalone Request Authentication does not necessarily restrict access to your Services. It only allows you to <strong>authenticate</strong> requests and ensures that JWT tokens are issued by a trusted issuer. The extracted identity details (like the <strong>requestPrincipals</strong> property) still have to be validated in respective Authorization Policies. In case of untrusted JWT issuers or an invalid token, the request will still be forwarded, but is considered &quot;un-authenticated&quot;. Therefore, the required <strong>identity details</strong> to pass an Authorization Policy are missing!</p></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> security.istio.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RequestAuthentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Any request targeting the Kyma API Service workload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Check if request contains a valid JWT token issued by XSUAA instance of the the Provider Subaccount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jwtRules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.authentication.us20.hana.ondemand.com/oauth/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">jwksUri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.authentication.us20.hana.ondemand.com/token_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># As the JWT token of the initial user request shall be retained a custom header is being used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fromHeaders</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">jwt</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">assertion</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>An Istio <strong>Authorization Policy</strong> ensures, that our API Service can only be reached by requests proving a dedicated Issuer and Subject claim as part of the <strong>validated identity details</strong>. In our sample scenario, we check the <strong>requestPrincipals</strong> property, which is following the structure - <strong>\&lt;JWT-Issuer<!-- -->&gt;<!-- -->/\&lt;JWT-Subject<!-- -->&gt;</strong>. Keep in mind, if the JWT token in the <strong>x-jwt-assertion</strong> header is invalid or has not been issued by a trusted XSUAA tenant, this property will be empty and the request is blocked!</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><strong>Hint</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>In case of XSUAA, the JWT issuer equals the <strong>token endpoint</strong> of the Provider Subaccount XSUAA Tenant (like <a href="https://sap-demo.authentication.us20.hana.ondemand.com/oauth/token" target="_blank" rel="noopener noreferrer">https://sap-demo.authentication.us20.hana.ondemand.com/oauth/token</a>) and the <strong>Subject claim</strong> contains the Client Id of the API XSUAA Service Instance. The default Subject structure follows <strong>sb-\&lt;Release-Name<!-- -->&gt;<!-- -->-api-\&lt;Release-Namespace<!-- -->&gt;</strong> and has to be provided in the <em>values.yaml</em> file (like <strong>sb-susaas-api-default</strong>). The asterisk is used on purpose in this case, as the Client Ids generated by XSUAA always contain a random character sequence after the exclamation mark! </p></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> security.istio.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AuthorizationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ALLOW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Any request targeting the Kyma API Service workload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Only grant access if Issuer and Subject of the authenticated request match a defined pattern</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># The Issuer has to match the XSUAA token endpoint of the Provider Subaccount </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># The prefix of the Subject claim has to match the Client Id of the API XSUAA Service Instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Will only be available if Request Authentication was successful</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requestPrincipals</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.authentication.us20.hana.ondemand.com/oauth/token/sb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">susaas</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">default</span><span class="token tag" style="color:#00009f">!*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>The Istio <strong>Destination Rule</strong> is another resource used in this sample and allows us to use simple TLS communication for egress traffic targeting SAP API Management. As Istio enforces mutual TLS as default communication within the service mesh, any exception has to be explicitly defined. Just to let you know : ) </p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Source: susaas/charts/api/templates/apim-proxy/istio-dest-rule-apim.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DestinationRule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> susaas</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">apim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.prod.apimanagement.us20.hana.ondemand.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">trafficPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">portLevelSettings</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SIMPLE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>This is it, now you should be in the know about how the secure integration of SAP API Management is set up in our sample scenario. An alerted reader might probably ask the following additional question now. Why all the fuzz about a custom header? Couldn&#x27;t we just use the <strong>Authorization</strong> header for this purpose? Excellent question and for a proper answer, let us check the visualization once again. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_KymaRouting.png&amp;quot; width=&amp;quot;700&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_KymaRouting-dfeff21931d13dacdb290f1bbed61463.png" width="1362" height="734" class="img_ev3q"></p><p>While the Authorization header would obviously be the go-to place for such a JWT token, it is unfortunately already occupied by the initial request. It contains a JWT token issued by the XSUAA tenant of the  <strong>Subscriber Subaccount</strong> and is used by CAP to identify the Tenant in our multitenancy context. So we have to retain this token and loop it through the whole process. For that reason, we decided to store the additional JWT token (identifying a successful processing by API Management) in a custom header. </p><p>While you are an expert for the theoretical concept now, let&#x27;s face the school of hard knocks and decent into the engine room of SAP API Management. Time for some API Policies! </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-api-policy-deep-dive">5. API Policy Deep Dive<a href="#5-api-policy-deep-dive" class="hash-link" aria-label="Direct link to 5. API Policy Deep Dive" title="Direct link to 5. API Policy Deep Dive">​</a></h2><p>The API Policies of our sample API Proxy are primarily based on SAP API Management Standard features. In the following section of the tutorial, you will learn how to set up some of the used API Policies yourself. This includes a Spike Arrest component for rate limiting and different Quotas based on the plan (standard/premium) selected by a Subscriber. </p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span><mdxadmonitiontitle><strong>Important</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>The following steps have already been completed in the sample API Proxy which you deployed in the beginning of this tutorial (<strong>APIProxy.zip</strong>). If you want to redo the following part of the step-by-step guide, feel free to remove the existing API Proxy and upload the <strong>APIProxyPolicies.zip</strong>. Otherwise, just follow along and try to reflect the steps and components in your existing API Proxy.  </p></div></div><p>To view and change the policies of an API Proxy, just click on <strong>Policies</strong> in the top right of your API Proxy.</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Policies.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="data:image/png;base64,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" width="374" height="133" class="img_ev3q"></p><p>Switch to edit mode by clicking on <strong>Edit</strong> in the Policy Editor. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_EditMode.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_EditMode-422a431a4ebf3472a132d18d7b692926.png" width="467" height="249" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-decode-jwt-token-policy">5.1. Decode JWT Token Policy<a href="#51-decode-jwt-token-policy" class="hash-link" aria-label="Direct link to 5.1. Decode JWT Token Policy" title="Direct link to 5.1. Decode JWT Token Policy">​</a></h3><p>Let us start with the <strong>PreFlow</strong> of our API Proxy, in which we place the <strong>Rate Limiter</strong> of our SaaS API. Check the following <a href="https://help.sap.com/docs/SAP_CLOUD_PLATFORM_API_MANAGEMENT/66d066d903c2473f81ec33acfe2ccdb4/08b40d9e47a0470a8b14cc47abab89ec.html?locale=en-US" target="_blank" rel="noopener noreferrer">SAP Help documentation</a> to learn more about the <strong>Flow</strong> types in SAP API Management.</p><p>5.1.1. In this use-case, we distinguish our API clients by their unique Client ID, which can be found in the JWT token of each request (! this time the JWT token in the default Authorization header !). Therefore if you decided to rebuild the API Policies from scratch, please add the API feature called <strong>DecodeJWT</strong>, allowing you to make use of the decoded JWT token in subsequent steps. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_DecodeJWT01.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_DecodeJWT01-89a72605084c745d79fc7791e3d11121.png" width="1486" height="445" class="img_ev3q"></p><p>5.1.2. If you are rebuilding the API Policies from scratch, rename the flow element <strong>decodeJwt</strong>. If you choose a different name, please keep track of it, as you will need it in one of the next steps. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_DecodeJWT02.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_DecodeJWT02-6666df99534b27d7167633be637bdc20.png" width="651" height="328" class="img_ev3q"></p><p>5.1.3. If you are rebuilding the API Policies from scratch, please remove the <strong><code>&lt;Source&gt;var.jwt&lt;/Source&gt;</code></strong> line from the configuration. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_DecodeJWT03.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_DecodeJWT03-0544f88c420eaa1f0b9966e6355f0ae9.png" width="761" height="215" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-spike-arrest-policy">5.2. Spike Arrest Policy<a href="#52-spike-arrest-policy" class="hash-link" aria-label="Direct link to 5.2. Spike Arrest Policy" title="Direct link to 5.2. Spike Arrest Policy">​</a></h3><p>The Spike Arrest Policy allows you to throttle the number of requests processed by your API Proxy. It protects you against performance lags as well as downtimes and is an essential component of each enterprise-ready API Proxy. </p><p>5.2.1. After decoding the JWT token, we can make use of the <strong>Spike Arrest</strong> feature in our policies toolbox. If you are rebuilding the API Policies from scratch, please add a new instance and rename the flow element <strong>spikeArrest</strong>. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_SpikeArrest01.png&amp;quot; width=&amp;quot;500&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_SpikeArrest01-3ff9adf5f4634b9239696642989f00ea.png" width="1464" height="441" class="img_ev3q"></p><p>5.2.2. The Spike Arrest instance requires a Client identifier which is the Client Id in our scenario. The Client Id is origination from the previous flow element (used to decode the JWT token). If you are rebuilding the API Policies from scratch, you might need to change the <strong>decodeJwt</strong> value in case you named your initial flow element differently. </p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Identifier</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">jwt.decodeJwt.claim.client_id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5.2.3. Feel free to adapt the number of requests which you want to allow per minute (pm) or second (ps). Check the documentation <a href="https://docs.apigee.com/api-platform/reference/policies/spike-arrest-policy" target="_blank" rel="noopener noreferrer">click here</a> of Spike Arrest as the configuration options are extremely comprehensive. </p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Rate</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1ps</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Rate</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> instead of </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Rate</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">30pm</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Rate</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_SpikeArrest02.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_SpikeArrest02-033cccd85fdae2261455fc1c4c928880.png" width="778" height="613" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-api-quota-policies">5.3. API Quota Policies<a href="#53-api-quota-policies" class="hash-link" aria-label="Direct link to 5.3. API Quota Policies" title="Direct link to 5.3. API Quota Policies">​</a></h3><p>Besides an API Rate Limit (protecting our SaaS API from DoS attacks), we enhance our API Proxy by introducing a <strong>plan-based Quota</strong>. This allows us to differentiate standard from premium customers, offering different service levels (like number of requests per day) for the SaaS API. </p><p>5.3.1. To differentiate between the different API service plans, we are using <strong>Subflows</strong>. Those Subflows will be executed based on a certain condition, after the PreFlow was executed. If you are rebuilding the API Policies from scratch, just create a new Subflow for the <strong>Proxy Endpoint</strong>, by clicking on the <strong>+</strong> icon.</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Quota01.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Quota01-07d8d4547b7548dded52d3afa177eb6c.png" width="1001" height="415" class="img_ev3q"></p><p>5.3.2. We use three Subflows called <strong>standardPlanFlow</strong>, <strong>premiumPlanFlow</strong> and <strong>trialPlanFlow</strong>. These Subflows will be executed right after the generic PreFlow, depending on conditions you define. The PreFlow is executed for <strong>all</strong> requests. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Quota02.png&amp;quot; width=&amp;quot;200&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Quota02-2e5191efe0f1acb5a0b58376c3765996.png" width="365" height="247" class="img_ev3q"></p><p>5.3.3. Once again, we differentiate our requests by using the decoded JWT token data. Our SaaS API Service Broker ensures, that the selected <strong>service plan</strong> is injected as a <strong>scope</strong> to all issued JWT tokens. This allows you to read the service plan details and to include it in the <strong>Flow Condition</strong> as follows: </p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><strong>Hint</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>If you are rebuilding the API Policies from scratch, please select the <strong>standardPlanFlow</strong> before adding the condition. </p></div></div><p>  <code>jwt.decodeJwt.claim.scope ~ &quot;*plan_standard&quot;</code></p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Quota03.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Quota03-7f3845a83193d42c5abcdeb71cd14924.png" width="1185" height="648" class="img_ev3q"></p><p>5.3.4. For the premiumPlanFlow the condition looks as follows.</p><p>  <code>jwt.decodeJwt.claim.scope ~ &quot;*plan_premium&quot;</code></p><p>5.3.5. For the trialPlanFlow the condition looks as follows.</p><p>  <code>jwt.decodeJwt.claim.scope ~ &quot;*plan_trial&quot;</code></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><strong>Hint</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>Reading the service plan from the JWT token scopes might be improved by a different approach in the future.</p></div></div><p>5.3.6. Now requests will be handled by the different Subflows depending on the consumer&#x27;s service plan selection. In those Subflows, we can define different <strong>Quota</strong> allowances. To add a very simple <strong>Quota limit</strong> to the API, we use the <strong>Quota</strong> feature from the policies toolbox. If you are rebuilding the API Policies from scratch, name the new flow elements <strong>quotaStandard</strong> in the standard, <strong>quotaPremium</strong> in the premium and <strong>quotaTrial</strong> in the trial flow. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Quota04.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Quota04-1230603f5fef4571a1dc511eaa47f90a.png" width="1486" height="561" class="img_ev3q"></p><p>5.3.7. For our sample application, the <strong>standard</strong> and <strong>trial</strong> quota is configure as below. This configuration allows API customers exactly 1200 daily requests to your API. The comprehensive configuration options of the <strong>Quota</strong> policy can be found in the respective documentation <a href="https://docs.apigee.com/api-platform/reference/policies/quota-policy" target="_blank" rel="noopener noreferrer">click here</a>. </p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span><mdxadmonitiontitle><strong>Important</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>Please ensure, the <strong>Quota</strong> policy configuration once again contains the <strong>Client Id</strong> identifier as in the following sample.</p></div></div><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Quota</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">async</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">false</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">continueOnError</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">false</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">enabled</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">calendar</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.sap.com/apimgmt</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Identifier</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">jwt.decodeJwt.claim.client_id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Allow</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">count</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">1200</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Interval</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Interval</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Distributed</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Distributed</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">StartTime</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2015-2-11 12:00:00</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">StartTime</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Synchronous</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Synchronous</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">TimeUnit</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">day</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">TimeUnit</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Quota</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><strong>Hint</strong> </mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>For the <strong>premium plan</strong>, you we double the number of daily requests to 2400, but feel free to update it to a configuration of your choice.  </p></div></div><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Quota05.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Quota05-56d5e86d746954787ac3dc5d64a82d44.png" width="943" height="592" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-kyma-authentication-policies">5.4. Kyma Authentication Policies<a href="#54-kyma-authentication-policies" class="hash-link" aria-label="Direct link to 5.4. Kyma Authentication Policies" title="Direct link to 5.4. Kyma Authentication Policies">​</a></h3><p>The custom <strong>x-jwt-assertion</strong> header (which is used by Kyma to check whether a request has successfully passed the API Polices) is injected as part of the <strong>TargetEndpoint - PreFlow</strong>. Without going into further details, the respective elements in the <strong>PreFlow</strong> will request an <strong>access token</strong> from the XSUAA token endpoint stored within the <strong>Key Value Maps</strong> created in the beginning of this tutorial. For authentication, the associated <strong>Client Id</strong> and <strong>Secret</strong> (also stored in the Key Value Maps) are used. This JWT access token, is <strong>cached</strong> in SAP API Management based on its validity date and is automatically reused for further requests if applicable. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_KymaAuth.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_KymaAuth-f6e08ac2760c559be7bdd4958c2456cf.png" width="1457" height="607" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="55-statistics-collection-policies">5.5. Statistics Collection Policies<a href="#55-statistics-collection-policies" class="hash-link" aria-label="Direct link to 5.5. Statistics Collection Policies" title="Direct link to 5.5. Statistics Collection Policies">​</a></h3><p>As part of the <strong>TargetEndpoint - PostFlow</strong>, the requested (or cached) XSUAA JWT access token will be added to the HTTP request as <strong>x-jwt-assertion</strong> custom header. As defined in our API Proxy settings, the <strong>Target Endpoint</strong> is finally again the API Service of our Kyma Cluster (e.g., susaas-api-default.a1b2c3d4.kyma.ondemand.com). If a successful response is returned from our API Service workload, some statistic details are stored before finally returning the response to the client. This includes the requested OData Entity and the XSUAA zone of the client. These details can later be visualized in a custom Monitoring dashboard. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Statistics.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Statistics-026f3d58c03af7def45f1156543497a1.png" width="1457" height="581" class="img_ev3q"></p><p>A very simple Monitoring dashboard using these dimensions could look as follows.</p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_StatisticDashboard.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_StatisticDashboard-d145ce1f5b0857736f2a99cad143be8e.png" width="1621" height="1027" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="56-update-api-proxy-and-deploy-changes">5.6. Update API Proxy and deploy changes<a href="#56-update-api-proxy-and-deploy-changes" class="hash-link" aria-label="Direct link to 5.6. Update API Proxy and deploy changes" title="Direct link to 5.6. Update API Proxy and deploy changes">​</a></h3><p>5.6.1. If you are rebuilding the API Policies from scratch, or you changed any of the existing policies, please click on <strong>Update</strong> in the upper right of your <strong>Policy Editor</strong>. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Deploy01.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="data:image/png;base64,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" width="324" height="70" class="img_ev3q"></p><p>5.6.2. Save your API Proxy changes by clicking on <strong>Save</strong>. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Deploy02.png&amp;quot; width=&amp;quot;200&amp;quot; /&amp;gt;" src="data:image/png;base64,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" width="211" height="59" class="img_ev3q"></p><p>5.6.3. Make sure to <strong>Deploy</strong> the latest version of your API Proxy by selecting the respective option. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_Deploy03.png&amp;quot; width=&amp;quot;300&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_Deploy03-abdfea5a3a3e5e38f2d8abea98b438f7.png" width="445" height="261" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-test-the-setup">6. Test the setup<a href="#6-test-the-setup" class="hash-link" aria-label="Direct link to 6. Test the setup" title="Direct link to 6. Test the setup">​</a></h2><p>That&#x27;s it, you&#x27;ve successfully integrated your Kyma-based SaaS API with SAP API Management and configured some API Policies. To test the setup, feel free to create a new service key in a Subscriber Subaccount (or use an existing one) and try calling your API endpoint e.g., using the sample HTTP files.</p><p>You will notice that calling the API more than once per second (e.g. using Postman or the HTTP files), will result in an error message sent by SAP API Management as the Spike Arrest (Rate Limit) policy will jump in. </p><p> <img loading="lazy" alt="&amp;lt;img src=&amp;quot;./images/API_SpikeArrest.png&amp;quot; width=&amp;quot;600&amp;quot; /&amp;gt;" src="/PAA/assets/images/API_SpikeArrest-3faedddb5a64527e100ff1622a3852d4.png" width="983" height="558" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-further-information">7. Further Information<a href="#7-further-information" class="hash-link" aria-label="Direct link to 7. Further Information" title="Direct link to 7. Further Information">​</a></h2><p>Please use the following links to find further information on the topics above:</p><ul><li><a href="https://help.sap.com/docs/SAP_INTEGRATION_SUITE?locale=en-US" target="_blank" rel="noopener noreferrer">SAP Help - SAP Integration Suite</a></li><li><a href="https://help.sap.com/docs/SAP_CLOUD_PLATFORM_API_MANAGEMENT?locale=en-US" target="_blank" rel="noopener noreferrer">SAP Help - SAP API Management</a></li><li><a href="https://docs.apigee.com/api-platform/reference/policies/" target="_blank" rel="noopener noreferrer">apigee Documentation - Policy reference overview</a></li><li><a href="https://docs.apigee.com/api-platform/reference/policies/spike-arrest-policy" target="_blank" rel="noopener noreferrer">apigee Documentation - SpikeArrest policy</a></li><li><a href="https://docs.apigee.com/api-platform/reference/policies/quota-policy" target="_blank" rel="noopener noreferrer">apigee Documentation - Quota policy</a></li><li><a href="https://help.sap.com/docs/SAP_CLOUD_PLATFORM_API_MANAGEMENT/66d066d903c2473f81ec33acfe2ccdb4/08b40d9e47a0470a8b14cc47abab89ec.html?locale=en-US" target="_blank" rel="noopener noreferrer">SAP Help - Flows</a></li><li><a href="https://help.sap.com/docs/SAP_CLOUD_PLATFORM_API_MANAGEMENT/66d066d903c2473f81ec33acfe2ccdb4/66561009a5b343658be2408981d005bb.html?locale=en-US" target="_blank" rel="noopener noreferrer">SAP Help - Condition Strings</a></li><li><a href="https://help.sap.com/docs/SAP_CLOUD_PLATFORM_API_MANAGEMENT/66d066d903c2473f81ec33acfe2ccdb4/c918e2803dfd4fc487e86d0875e8462c.html?locale=en-US" target="_blank" rel="noopener noreferrer">SAP Help - Policy Types</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-08-29T06:17:59.000Z">Aug 29, 2023</time></b> by <b>Navya khurana</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/PAA/project-panel/advanced/push-data-s4hana-system"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Push data from SAP S/4HANA system</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/PAA/category/expert"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Expert</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-architecture" class="table-of-contents__link toc-highlight">1. Architecture</a></li><li><a href="#2-prerequisites" class="table-of-contents__link toc-highlight">2. Prerequisites</a></li><li><a href="#3-integration-setup" class="table-of-contents__link toc-highlight">3. Integration Setup</a></li><li><a href="#4-under-the-hood" class="table-of-contents__link toc-highlight">4. Under the hood</a></li><li><a href="#5-api-policy-deep-dive" class="table-of-contents__link toc-highlight">5. API Policy Deep Dive</a><ul><li><a href="#51-decode-jwt-token-policy" class="table-of-contents__link toc-highlight">5.1. Decode JWT Token Policy</a></li><li><a href="#52-spike-arrest-policy" class="table-of-contents__link toc-highlight">5.2. Spike Arrest Policy</a></li><li><a href="#53-api-quota-policies" class="table-of-contents__link toc-highlight">5.3. API Quota Policies</a></li><li><a href="#54-kyma-authentication-policies" class="table-of-contents__link toc-highlight">5.4. Kyma Authentication Policies</a></li><li><a href="#55-statistics-collection-policies" class="table-of-contents__link toc-highlight">5.5. Statistics Collection Policies</a></li><li><a href="#56-update-api-proxy-and-deploy-changes" class="table-of-contents__link toc-highlight">5.6. Update API Proxy and deploy changes</a></li></ul></li><li><a href="#6-test-the-setup" class="table-of-contents__link toc-highlight">6. Test the setup</a></li><li><a href="#7-further-information" class="table-of-contents__link toc-highlight">7. Further Information</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/PAA/">Overview</a></li></ul></div><div class="col footer__col"><div class="footer__title">SAP Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blogs.sap.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blogs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://answers.sap.com/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Q&amp;A<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discovery-center.cloud.sap/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discovery Center<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/SAP-samples/btp-kyma-cap-multitenant-susaas" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Repo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/PAA/assets/js/runtime~main.f3fc8105.js"></script>
<script src="/PAA/assets/js/main.7d67572a.js"></script>
</body>
</html>
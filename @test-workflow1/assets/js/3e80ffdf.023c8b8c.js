"use strict";(self.webpackChunkpaa_doc=self.webpackChunkpaa_doc||[]).push([[7339],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>h});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=n.createContext({}),c=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(o.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(a),d=r,h=m["".concat(o,".").concat(d)]||m[d]||u[d]||i;return a?n.createElement(h,s(s({ref:t},p),{},{components:a})):n.createElement(h,s({ref:t},p))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,s=new Array(i);s[0]=d;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l[m]="string"==typeof e?e:r,s[1]=l;for(var c=2;c<i;c++)s[c]=a[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},99826:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const i={},s="Template Details",l={unversionedId:"project-panel/basic/kyma-resources-helm/components/TemplateDetails",id:"project-panel/basic/kyma-resources-helm/components/TemplateDetails",title:"Template Details",description:"This chapter provides detailed information on the various Helm templates and corresponding Kyma and Kubernetes resources. If you are new to Helm and have not checked out the provided introduction yet, we strongly recommend to read the respective Helm Charts chapter first. While the subsequent Resource Overview chapter describes the general purpose of the different Kyma and Kubernetes resource types, in this part of the tutorial, we cover the scenario-related usage of the various components.",source:"@site/docs/project-panel/2-basic/8-kyma-resources-helm/components/TemplateDetails.md",sourceDirName:"project-panel/2-basic/8-kyma-resources-helm/components",slug:"/project-panel/basic/kyma-resources-helm/components/TemplateDetails",permalink:"/PAA/@test-workflow1/project-panel/basic/kyma-resources-helm/components/TemplateDetails",draft:!1,tags:[],version:"current",lastUpdatedBy:"Navya Khurana",lastUpdatedAt:1739895491,formattedLastUpdatedAt:"Feb 18, 2025",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Resource Overview",permalink:"/PAA/@test-workflow1/project-panel/basic/kyma-resources-helm/components/ResourceOverview"},next:{title:"Explore the application components",permalink:"/PAA/@test-workflow1/project-panel/basic/explore-the-components/"}},o={},c=[{value:"Umbrella Chart",id:"umbrella-chart",level:2},{value:"API Service",id:"api-service",level:2},{value:"API Service Broker",id:"api-service-broker",level:2},{value:"Application Router",id:"application-router",level:2},{value:"SaaS Backend Service",id:"saas-backend-service",level:2}],p={toc:c},m="wrapper";function u(e){let{components:t,...i}=e;return(0,r.kt)(m,(0,n.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"template-details"},"Template Details"),(0,r.kt)("p",null,"This chapter provides detailed information on the various Helm templates and corresponding Kyma and Kubernetes resources. If you are new to Helm and have not checked out the provided introduction yet, we strongly recommend to read the respective ",(0,r.kt)("a",{parentName:"p",href:"/PAA/@test-workflow1/project-panel/basic/kyma-resources-helm/components/HelmCharts"},"Helm Charts")," chapter first. While the subsequent ",(0,r.kt)("a",{parentName:"p",href:"/PAA/@test-workflow1/project-panel/basic/kyma-resources-helm/components/ResourceOverview"},"Resource Overview")," chapter describes the general purpose of the different Kyma and Kubernetes resource types, in this part of the tutorial, we cover the scenario-related usage of the various components."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#template-details"},"Template Details"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#umbrella-chart"},"Umbrella Chart")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#api-service"},"API Service")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#api-service-broker"},"API Service Broker")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#application-router"},"Application Router")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#saas-backend-service"},"SaaS Backend Service"))))),(0,r.kt)("p",null,"Once again, you might find the following visualizations useful, as you will be able identify and allocate many of the described resources. "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Architecture Diagram")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"&lt;img src=&quot;./images/ResourceDetailsArch.png&quot; width=&quot;600&quot;/&gt;",src:a(84850).Z,width:"1716",height:"986"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Component Details")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"&lt;img src=&quot;./images/KymaObjectsGeneral.png&quot; width=&quot;600&quot;/&gt;",src:a(83977).Z,width:"1516",height:"820"})),(0,r.kt)("p",null,"The recommended way to deploy our Sustainable SaaS sample application is the usage of the provided Helm Umbrella Chart. Doing so, you can maintain all environment specific settings in one place (values.yaml) and deploy all Helm Subcharts using one single Helm installation. "),(0,r.kt)("h2",{id:"umbrella-chart"},"Umbrella Chart"),(0,r.kt)("p",null,"The Umbrella Chart ",(0,r.kt)("em",{parentName:"p"},"/charts/sustainable-saas")," directory, allows you to conduct a Helm installation including all relevant components of the Sustainable SaaS sample application like Application Router, Backend Service, API Broker and API Service. Furthermore, it contains the templates for all required SAP BTP Service Instances, as well as Kubernetes Job templates for the SAP HANA and HTML5 Application Deployments. "),(0,r.kt)("p",null,"For a default installation, it is sufficient to update the ",(0,r.kt)("strong",{parentName:"p"},"values.yaml")," file (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/values.yaml"},"values.yaml"),") of the Helm Umbrella Chart with your own environment settings, before starting a Helm installation. Still, all required values are also available in the respective Subcharts. Therefore, it is also possible to install the different Subcharts like the Application Router or the Backend Service separately, by copying the properties from the Helm Umbrella Chart ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file to the respective ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," files of the Subcharts. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"Chart.yaml          # Helm Umbrella Chart referencing all Subcharts\nvalues.schema.json  # Schema definition for Values.yaml file\nvalues.yaml         # values.yaml for Helm Umbrella Chart\nxs-security.json    # Settings for XSUAA Service Instance\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Good to know")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"As most SAP BTP services (e.g. XSUAA) are used by multiple components of our application (e.g. Application Router and Backend Service), we defined the SAP BTP Service Instances on Umbrella Chart level. An alternative approach would be a separate Helm Subchart, being used to create the shared SAP BTP Service Instances. ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"While processing the XSUAA Service Instance template, Helm will read and include the provided ",(0,r.kt)("em",{parentName:"p"},"xs-security.json")," configuration file. If you reference further configuration files in your ",(0,r.kt)("em",{parentName:"p"},"values.yaml"),", you need to place the respective files next to your ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file. "))),(0,r.kt)("p",null,"*",(0,r.kt)("strong",{parentName:"p"},"*charts/sustainable-saas/templates**")),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"templates")," directory of the Helm Umbrella Chart contains templates for all SAP BTP Service Instances, as well as templates for our Kubernetes Jobs. Additionally, the directory contains some template helper files used by Helm. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"# Service Broker Secret definition        \nbroker_secret.yaml \n# SAP HANA HDI Container definition (Shared/Common Container)\ncom_hdi_container.yaml \n# SAP BTP - Destination Service definition           \ndestination.yaml\n# SAP HANA Deployer (Shared/Common Container) Job definition      \nhana_deployer_job.yaml\n# HTML5 Repository Deployer Job definition        \nhtml5_apps_deployer_job.yaml\n# HTML5 Application Repository (Host Service) definition  \nhtml5_apps_repo_host.yaml\n# HTML5 Application Repository (Runtime Service) definition     \nhtml5_apps_repo_runtime.yaml\n# Cloud Identity Service (Application) definition     \nidentity.yaml\n# Helm deployment message definition\nNOTES.txt\n# SAP BTP - SaaS Registry Service definition\nsaas_registry.yaml \n# SAP BTP - Service Manager (Subaccount Admin plan) Service definition\nsm_admin.yaml \n# SAP BTP - Service Manager (Container plan) Service definition\nsm_container.yaml\n# SAP BTP - XSUAA Service definition (for SaaS App) \nxsuaa.yaml \n# SAP BTP - XSUAA Service definition (for SaaS API)\nxsuaa_api.yaml\n# Helm templating helper file\n_deployment_helpers.tpl \n# Helm templating helper file\n_helpers.tpl\n# Helm templating helper file\n_sapcp_helpers.tpl \n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Good to know")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The SAP BTP Service Instance templates need to match the names of the services defined in the ",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/values.yaml"},(0,r.kt)("strong",{parentName:"a"},"values.yaml file"))," of the Umbrella Chart, whereas underscores are converted to hyphens automatically. For each Service Instance defined in the values.yaml file, a corresponding template file has to exist. Otherwise, the Service Instance is not being generated. ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Broker Secret")," automatically generates a Service Broker user and password upon deployment. Binding the Secret to the API Service Broker and the Backend Service allows simplified retrieval of these credentials at runtime."),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"broker_secret.yaml"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Secret\ntype: Opaque\ndata:\n    # Broker user set to default value "broker-user"\n    BROKER_USER : {{ "broker-user" | b64enc | quote }}\n    # Broker password created as a random alpha numeric string of 32 characters length\n    {{- $password := (randAlphaNum 32  | b64enc ) }}\n    BROKER_PASSWORD : {{ $password | quote }}\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Helm Job templates for deploying the UI5 apps to the HTML5 Application Repository (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/templates/html5_apps_deployer_job.yaml"},"click here"),") and the shared data model to the HDI Container instance (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/templates/hana_deployer_job.yaml.yaml"},"click here"),"), are also part of the Helm Umbrella Chart templates.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Service Manager Instance (",(0,r.kt)("strong",{parentName:"p"},"Subaccount Admin")," plan - ",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/templates/sm_admin.yaml"},"click here"),") allows our sample application to create a so-called Cloud Management Service Instance (",(0,r.kt)("strong",{parentName:"p"},"Central")," plan) at runtime (",(0,r.kt)("a",{parentName:"p",href:"https://discovery-center.cloud.sap/serviceCatalog/cloud-management-service/?region=all"},"click here")," for details). This Service Instance created at runtime, is required to create Service Manager Instances in the Subscriber Subaccounts. These Service Manager Instances can then be used to register API Service Brokers in the Subscriber Subaccounts.\n"))),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"mdxAdmonitionTitle"},"Important")," "),(0,r.kt)("p",{parentName:"admonition"},"The default Service Manager Service Instance (",(0,r.kt)("strong",{parentName:"p"},"Operator Access")," plan) - used by Kyma to create Service Instances in the Provider Subaccount - can unfortunately not be used to create the required CIS Central instance. ")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"As already explained, each Service Instance defined in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file requires a corresponding template in the ",(0,r.kt)("em",{parentName:"p"},"templates")," folder. Most of these template files, simply include a template reference (",(0,r.kt)("em",{parentName:"p"},"cap.service-instance"),") defined in the ",(0,r.kt)("em",{parentName:"p"},"_helpers.tpl")," helper file. This generic approach saves us from defining dedicated SAP BTP Service Instance templates for each SAP BTP Service Instance."),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"sm_admin.yaml")),(0,r.kt)("pre",{parentName:"blockquote"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'{{- include "cap.service-instance" . }}\n'))),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"_helpers.tpl"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'# Helm template for SAP BTP Service Instances\n{{- define "cap.service-instance" -}} \n{{- $service := get .Values $key }}\n{{- if $service }}\n    {{- if or (not (hasKey $service "enabled")) $service.enabled }}\n        {{- $name := $key | replace "_" "-" }}\n        {{- $serviceParameters := $service.parameters | default (dict) }}\n    ...\n    {{ end }}\n{{ end }}\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Some Services Instance templates like the SaaS Registry require a slightly more complex template file. This is required when any of the Service Instance parameters requires dynamic values like e.g., the Backend Service URI as part of the getDependencies parameter below. If these parameters contain dynamic components, they cannot be provided as part of the static ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file."),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"saas_registry.yaml")),(0,r.kt)("pre",{parentName:"blockquote"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'{{- if (default dict .Values.multitenancy).enabled }}\n    # Include additional service configurations\n    {{- $srvHostFull := include "cap.deploymentHostFull" (\n          merge (dict "name" "srv" "deployment" .Values.srv) . \n        ) \n    }}\n    {{- $defaultAppUrls := dict\n        "getDependencies" (\n            print "https://" $srvHostFull "/-/cds/saas-provisioning/dependencies"\n        )\n        ...\n    }}\n    # Include default SAP BTP Service Instance template\n    {{- include "cap.service-instance" (\n          merge ( dict "defaultParameters" $defaultParameters ) .\n        ) \n    }}\n{{ end }}\n')))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Some SAP BTP Services Instances templates also use the so-called ",(0,r.kt)("a",{parentName:"p",href:"#https://helm.sh/docs/howto/charts_tips_and_tricks/#using-the-tpl-function"},"Helm ",(0,r.kt)("strong",{parentName:"a"},"tpl")," function"),". The tpl feature allows us to use the Helm template syntax in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file. One example is the Destination Service, which uses Helm template syntax within the ",(0,r.kt)("em",{parentName:"p"},"init_data")," parameters (of the ",(0,r.kt)("em",{parentName:"p"},"values.yaml"),"). This allows us to inject the dynamic values like the Backend Service URI into the SAP BTP Destination Service Instance parameters."),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"values.yaml"))),(0,r.kt)("p",{parentName:"li"},"  Using Helm templating syntax in the parameter values. "),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'destination:\n  serviceOfferingName: destination\n  servicePlanName: lite\n  parameters:\n    init_data:\n      instance:\n        destinations:\n          - Name: srv-api\n            URL: \'http://{{ include "cap.fullname" (\n                    merge (dict "name" "srv" "deployment" .Values.srv ) . \n                  ) }}:{{ .Values.srv.port }}\'\n          ...\n')),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"destination.yaml"))),(0,r.kt)("p",{parentName:"li"},"  Sends the ",(0,r.kt)("strong",{parentName:"p"},"init_data")," parameters (containing Helm templating syntax) to a helper function."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'{{- if (default dict .Values.multitenancy).enabled }}\n    # Apply template definitions provided in init_data values of the values.yaml file\n    {{- $defaultParameters := dict "init_data" (\n          include "template-value" ( dict "value" \n            ( .Values.destination.parameters.init_data "context" . ) \n          ) | fromYaml \n        )\n    }}\n    # Include default SAP BTP Service Instance template and merge parameters\n    {{- include "cap.service-instance" (  \n          merge ( dict "defaultParameters" $defaultParameters ) . \n        ) \n    }}\n{{ end }}\n')),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"_helpers.tpl"))),(0,r.kt)("p",{parentName:"li"},'  The Helm helper function "translates" the templating syntax as required. '),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'{{ define "template-value" }}\n  {{- if kindIs "string" .value }}\n    # The tpl function replaces e.g. {{ .Values.srv.port }} with the respective value\n    # It also applies the provided includes to build the correct Backend Service URI\n    {{- tpl .value .context }}\n  {{- else }}\n    {{- tpl (.value | toYaml) .context }}     \n  {{- end }}\n{{- end }}\n')),(0,r.kt)("p",{parentName:"li"},"  A sample resource definition generated by Helm could look like the following. "),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: services.cloud.sap.com/v1\nkind: ServiceInstance\nmetadata:\n  name: susaas-destination\nspec:\n  serviceOfferingName: destination\n  servicePlanName: lite\n  externalName: default-susaas-destination\n  parameters:\n    init_data:\n      instance:\n        destinations:\n        - Type: HTTP\n          # Target URL contains the dynamic Helm Release Name and correct Port\n          URL: http://susaas-srv:8080\n      ...\n")))),(0,r.kt)("h2",{id:"api-service"},"API Service"),(0,r.kt)("p",null,"The Sustainable SaaS API Service is defined as a separate Helm Subchart. Theoretically, this Subchart can also be deployed standalone, by copying the required values into the ",(0,r.kt)("em",{parentName:"p"},"/susaas-api/values.yaml")," file (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/charts/susaas-api/values.yaml"},"click here"),"). In our sample scenario, the required environment specific properties are defined in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file of the Helm Umbrella Chart. "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"charts/sustainable-saas/susaas-api")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"Chart.yaml # Chart.yaml of the SaaS API Service\nvalues.schema.json # Schema definition for Values.yaml file\nvalues.yaml # Values.yaml of the SaaS API Service\n\n\u2500\u2500\u2500templates\u2500\u2500\u2500\n_helpers.tpl # Default Helm template helpers\napi-rule.yaml # API Rule template exposing the SaaS API Service externally\ndeployment.yaml # Deployment template for the SaaS API Service \nistio-auth-policy.yaml # Authorization Policy template allowing access by Istio Ingress Gateway\nistio-sidecar.yaml # Default Sidecar limits required Istio configurations\nnetwork-policy.yaml # Network Policy allowing access by Istio Ingress Gateway only\npod-autoscaler.yaml # Horizontal Pod Autoscaler template based on CPU utilization\npod-disruption-budget.yaml # Pod Disruption Budget template for voluntary disruptions\nsecret.yaml # Secret template for potential Image Pull Secret \nservice-account.yaml # Service Account template for the SaaS API Service\nservice-binding.yaml # SAP BTP Service Binding template required by the SaaS API Service\nservice-keys.yaml # SAP BTP Service Binding template used to create standalone service keys\nservice.yaml # Cluster IP Service template for the SaaS API Service\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Good to know")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Authorization Policy of the API Service is configured to allow access by Istio Ingress Gateway only. This opens the API Service to external traffic, as the associated Istio Virtual Service (created by the given API Rule), routes all requests to the Cluster IP Service of the SaaS API Service workload (except for scenarios integrating SAP API Management). ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Authorization Policy, as well as the respective API Rule, are only being used, if the SAP API Management integration is not enabled. For the integration of SAP API Management, the API Rule is replaced by a dedicated Virtual Service definition in the ",(0,r.kt)("em",{parentName:"p"},"apim-proxy")," directory (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/charts/susaas-api/templates/apim-proxy/"},"click here")," or find details below). ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The API Service Subchart contains a special Helm template allowing you to create Service Keys. If any ",(0,r.kt)("strong",{parentName:"p"},"serviceKeys")," value is defined in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml"),", a corresponding SAP BTP Service Binding will be created. This will create new Client Credentials but compared to regular Service Bindings (",(0,r.kt)("strong",{parentName:"p"},"bindings")," property), the generated Secrets will not be mounted to the workload. "))),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"mdxAdmonitionTitle"},"Hint")," "),(0,r.kt)("p",{parentName:"admonition"},"A Service Key is required for the Integration of SAP API Management, as dedicated Client Credentials of the API XSUAA Service Instance have to be stored in SAP API Management. This way, requests originating from SAP API Management can be securely authenticated. ")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"API Management Proxy")," "),(0,r.kt)("p",null,"The API Management Proxy directory (",(0,r.kt)("strong",{parentName:"p"},"apim-proxy")," - ",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/charts/susaas-api/templates/apim-proxy/"},"click here"),") contains various Istio templates to ensure a secure SAP API Management integration. As SAP API Management is a service running outside the Kyma Cluster, all requests targeting the SaaS API Service will initially leave the Kyma environment, and will return back to Kyma after the API Policies have been successfully checked (find more details below). "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"istio-auth-policy.yaml # Authorization Policy for traffic targeting the SaaS API workload\nistio-dest-rule-apim.yaml # Destination Rule for traffic targeting SAP API Management\nistio-request-auth.yaml # Request Authentication for traffic targeting the SaaS API workload\nistio-service-entry-apim.yaml # Service Entry to add SAP API Management as mesh external service\nistio-virtual-service.yaml # Virtual Service for routing to SAP API Management or the SaaS API workload\n")),(0,r.kt)("p",null,"To guarantee that no request can reach the API Service workloads without passing through SAP API Management, respective Istio resources ensure, that a valid JWT token is part of an incoming request. This JWT token is generated and injected by SAP API Management, based on Client Credentials of an XSUAA service instance. Below you can see a visualization, depicting how a request arriving through Istio Ingress Gateway is being processed."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"&lt;img src=&quot;./images/APIManagementArch.png&quot; width=&quot;800&quot;/&gt;",src:a(41220).Z,width:"1362",height:"734"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"First of all, a so-called  ",(0,r.kt)("strong",{parentName:"p"},"Service Entry")," makes SAP API Management known as an external service to the Service Mesh. This allows us to it e.g., as destination target of Virtual Services. ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"To integrate SAP API Management, a dedicated ",(0,r.kt)("strong",{parentName:"p"},"Istio Virtual Service")," is used, routing traffic based on a custom header (x-jwt-assertion). In case the header is missing (initial request), the request is routed to SAP API Management. If the custom header is available, traffic is forwarded to the API Service workload. "))),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"mdxAdmonitionTitle"},"Important")," "),(0,r.kt)("p",{parentName:"admonition"},"The custom header is injected by SAP API Management, after the request was processed and all Traffic Policies have been successfully checked.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"```yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nspec:\n  # Matches all requests arriving on host exposed by SusaaS API Service \n  gateways: \n    - demo-dns/sap-demo-gateway\n  hosts: \n    - susaas-api-default.sap-demo.com\n  http:\n    - match:\n        # Matches requests with x-jwt-assertion header (custom header)\n        - headers:\n            x-jwt-assertion: {}\n      # Routes requests to ClusterIP service of SusaaS API Service \n      route:\n        - destination:\n            host: susaas-api.default.svc.cluster.local\n            port:\n              number: 5000\n    # Matches requests without x-jwt-assertion header (custom header)\n    - match:\n        - withoutHeaders:\n            x-jwt-assertion: {}\n      # Rewrite URL path to add API Proxy path and authority details\n      rewrite:\n        uri: /kyma-api-susaas/\n        authority: sap-demo.prod.apimanagement.us20.hana.ondemand.com\n      # Routes to SAP API Management defined in the Service Entry\n      route:\n        - destination:\n            host: sap-demo.prod.apimanagement.us20.hana.ondemand.com\n            port:\n              number: 443\n```\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"An Istio ",(0,r.kt)("strong",{parentName:"p"},"Request Authentication")," ensures, that all requests targeting the API Service workload are checked for a ",(0,r.kt)("strong",{parentName:"p"},"valid")," JWT token, provided by a trusted issuers. If this is the case, the incoming request is considered authenticated and respective identity details can be used in subsequent Authorization Policies. "),(0,r.kt)("admonition",{parentName:"li",type:"tip"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"mdxAdmonitionTitle"},"Hint")," "),(0,r.kt)("p",{parentName:"admonition"},"A Request Authentication without an Authorization Policy does not restrict access to your workloads. It only allows you to ",(0,r.kt)("strong",{parentName:"p"},"authenticate"),' requests and ensures that JWT tokens are issued by a trusted issuer. The authentication details (like the identity available in the requestPrincipals property) can afterwards be validated in Authorization Policies. In case the JWT provider does not match a trusted issuer, the request will still be forwarded, but is considered "un-authenticated" not containing any identity details. ')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: security.istio.io/v1beta1\nkind: RequestAuthentication\nspec:\n  # Any request targeting the Kyma API Service workload\n  selector:\n    matchLabels: \n      app.kubernetes.io/name: api\n  # Check if request contains a valid JWT token issued by XSUAA instance of the the Provider Subaccount\n  jwtRules:\n    - issuer: https://sap-demo.authentication.us20.hana.ondemand.com/oauth/token\n      jwksUri: https://sap-demo.authentication.us20.hana.ondemand.com/token_keys\n      # As the JWT token of the initial user request shall be retained a custom header is being used\n      fromHeaders:\n        - name: x-jwt-assertion\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"An Istio ",(0,r.kt)("strong",{parentName:"p"},"Authorization Policy")," finally ensures, that the API Service workloads can only be reached by requests providing a specific Issuer and Subject (sub) claim as part of the previously validated JWT token. This can be handled by checking the requestPrincipals property, which is provided in the following structure \\<JWT-Issuer",">","/\\<JWT-Subject",">",". "),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nspec:\n  action: ALLOW\n  # Any request targeting the Kyma API Service workload\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: api\n  # Only grant access if Issuer and Subject of the authenticated request match a defined pattern\n  # The Issuer has to match the XSUAA token endpoint of the Provider Subaccount \n  # The prefix of the Subject has to match the appname of the API XSUAA Service Instance (incl. sb-prefix)\n  rules:\n    - from:\n      - source:\n          # Will only be available if Request Authentication was successful\n          requestPrincipals: \n            - https://sap-demo.authentication.us20.hana.ondemand.com/oauth/token/sb-susaas-api-default!*\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Istio ",(0,r.kt)("strong",{parentName:"p"},"Destination Rule")," allows us to use simple TLS communication for egress traffic targeting SAP API Management. As Istio enforces mutual TLS as default communication within the mesh, any exception has to be explicitly defined. "))),(0,r.kt)("h2",{id:"api-service-broker"},"API Service Broker"),(0,r.kt)("p",null,"The Sustainable SaaS API Service Broker is defined as a separate Helm Subchart. Theoretically, this Subchart can also be deployed standalone, by copying the required values into the ",(0,r.kt)("em",{parentName:"p"},"/susaas-broker/values.yaml")," file (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/charts/susaas-broker/values.yaml"},"click here"),"). In this sample scenario, the required environment specific values are defined in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file of the Umbrella Helm Chart. "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"charts/sustainable-saas/susaas-broker")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"Chart.yaml # Chart.yaml of the API Service Broker\nvalues.schema.json # Schema definition for Values.yaml file\nvalues.yaml # Values.yaml of the API Service Broker\n\n\u2500\u2500\u2500templates\u2500\u2500\u2500\n_helpers.tpl # Default Helm template helpers\napi-rule.yaml # API Rule template exposing the API Service Broker externally\nbroker-catalog.yaml # API Service Broker catalog.json file template (e.g. service plans)\nbroker-service.yaml # Config Map template for the API Service Broker (e.g. xssecurity extensions)\ndeployment.yaml # Deployment template for the API Service Broker \nistio-auth-policy.yaml # Authorization Policy template allowing access by Istio Ingress Gateway\nistio-sidecar.yaml # Default Sidecar limits required Istio configurations\nnetwork-policy.yaml # Network Policy allowing access by Istio Ingress Gateway only\npod-autoscaler.yaml # Horizontal Pod Autoscaler template based on CPU utilization\npod-disruption-budget.yaml # Pod disruption budget template for voluntary disruptions\nsecret.yaml # Secret template for potential Image Pull Secret \nservice-account.yaml # Service Account template for the API Service Broker\nservice-binding.yaml # SAP BTP Service Binding template for the API Service Broker\nservice.yaml # ClusterIP Service template for the API Service Broker\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Good to know")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Authorization Policy of the SusaaS API Service Broker is configured to allow access by Istio Ingress Gateway only. This exposes the service to external traffic, as the associated Istio Virtual Service (created by the provided API Rule), routes all requests to the Cluster IP Service of the API Service Broker workload. ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The API Service Broker requires a Config Map Helm template, containing some extension definitions used by the Service Broker when generating new Client Credentials. "))),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"mdxAdmonitionTitle"},"Hint")," "),(0,r.kt)("p",{parentName:"admonition"},"These configurations extend the default API Service Broker settings and ensure that the ",(0,r.kt)("strong",{parentName:"p"},"service plan")," (selected by the subscriber) is added as a scope to tokens issued for the respective service instance. Another extension adds the API URI to all issued client credentials of respective service instances (so we do not have to provide them the URI manually). ")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'```yaml\napiVersion: v1\nkind: ConfigMap\ndata:\n  serviceConfigs: | -\n    { \n      "susaas-api-default-a1b2c3d4": {\n        "extend_credentials": {\n          "shared": {\n            # Adds the SaaS API URI to client credentials as an additional information\n            "apiUrl": "https://susaas-api-default.sap-demo.com"\n          }\n        },\n        "extend_xssecurity": {\n          "per_plan": {\n             "default": {\n               "authorities": [\n                  # Adds plan_default scope to tokens issued by "default-plan" service instances\n                  "$XSMASTERAPPNAME.plan_default"\n        ...\n```\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"An additional ConfigMap template (broker-catalog.yaml), results in a ",(0,r.kt)("em",{parentName:"li"},"catalog.json")," file mounted to the file system of our API Service Broker containers. This dynamic ConfigMap contains information about all service plans offered by our API Service Broker. ")),(0,r.kt)("h2",{id:"application-router"},"Application Router"),(0,r.kt)("p",null,"The Sustainable SaaS Application Router is defined in a separate Helm Subchart. This Subchart can also be deployed standalone, by copying the required values into the ",(0,r.kt)("em",{parentName:"p"},"/susaas-router/values.yaml")," file (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/charts/susaas-router/values.yaml"},"click here"),"). In this sample scenario, the required environment specific values are defined in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file of the Umbrella Helm Chart."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"charts/sustainable-saas/susaas-router")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"Chart.yaml # Chart.yaml of the Application Router\nvalues.schema.json # Schema definition for Values.yaml file\nvalues.yaml # Values.yaml of the Application Router\n\n\u2500\u2500\u2500templates\u2500\u2500\u2500\n_helpers.tpl # Default Helm template helpers\napi-rule.yaml # API Rule template exposing the Application Router externally\ndeployment.yaml # Deployment template for the Application Router\nistio-auth-policy.yaml # Authorization Policy template allowing access by Istio Ingress Gateway and Ory Oathkeeper\nistio-dest-rule.yaml # Destination Rule template enforcing mTLS\nistio-sidecar.yaml # Default Sidecar limits required Istio configurations\nnetwork-policy.yaml # Network Policy template allowing access by Istio Ingress Gateway and Ory Oathkeeper\npod-autoscaler.yaml # Horizontal Pod Autoscaler template based on CPU utilization\npod-disruption-budget.yaml # Pod disruption budget template for voluntary disruptions\nsecret.yaml # Secret template for potential Image Pull Secret \nservice-account.yaml # Service Account template for the Application Router\nservice-binding.yaml # SAP BTP Service Binding template for the Application Router\nservice.yaml # Cluster IP Service template for the Application Router\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Good to know")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Authorization Policy")," of the Application Router is configured to allow access by Istio Ingress Gateway and Ory Oathkeeper Proxy only. This exposes the Application Router to public traffic, as the associated Istio Virtual Services (created by corresponding the Kyma API Rule), route all requests to the Cluster IP Service of the Application Router workload. Either directly or through Ory Oathkeeper in case of Subscriber Tenant access. Latter injects the required ",(0,r.kt)("strong",{parentName:"p"},"x-custom-host")," header.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Like the Backend Service, also the Application Router uses a dedicated ",(0,r.kt)("strong",{parentName:"p"},"Service Account")," instead of the ",(0,r.kt)("strong",{parentName:"p"},"default")," one. This allows the usage of the corresponding Service Account ",(0,r.kt)("strong",{parentName:"p"},"Principal")," in the Authorization Policy of our Backend Services. Doing so, we can ensure that only the Application Router can communicate with our Backend Service. "))),(0,r.kt)("h2",{id:"saas-backend-service"},"SaaS Backend Service"),(0,r.kt)("p",null,"The Sustainable SaaS Backend Service is defined as a separate Helm Subchart. Like all the other Subcharts, also the Backend Service can be deployed standalone, by copying the required values in the ",(0,r.kt)("em",{parentName:"p"},"/susaas-srv/values.yaml")," file (",(0,r.kt)("a",{parentName:"p",href:"../../../../code/charts/sustainable-saas/charts/susaas-srv/values.yaml"},"click here"),"). In this sample scenario, the required environment specific values are defined in the ",(0,r.kt)("em",{parentName:"p"},"values.yaml")," file of the Umbrella Helm Chart. "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"charts/sustainable-saas/susaas-srv")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"Chart.yaml # Chart.yaml for the SaaS Backend Service\nvalues.schema.json # Schema definition for Values.yaml file\nvalues.yaml # Values.yaml for the SaaS Backend Service\n\n\u2500\u2500\u2500templates\u2500\u2500\u2500\n_helpers.tpl # Default Helm template helpers\napi-rule.yaml # API Rule template exposing the SaaS Backend Service\ncluster-role.yaml # Cluster Role template for permissions required during runtime\ndeployment.yaml # Deployment template for the SaaS Backend Service\nistio-auth-policy.yaml # Authorization Policy template allowing access by Istio Ingress Gateway and Application Router only\nistio-sidecar.yaml # Default Sidecar limits required Istio configurations\nnetwork-policy.yaml # Network Policy allowing access by Application Router and Istio Ingress Gateway\npod-autoscaler.yaml # Horizontal Pod Autoscaler template based on CPU utilization\npod-disruption-budget.yaml # Pod disruption budget template for voluntary disruptions\nrole-binding.yaml # Role Binding template to assign Cluster Role to Service Account\nsecret.yaml # Secret template for potential Image Pull Secret \nservice-account.yaml # Service Account template for the SaaS Backend Service\nservice-binding.yaml # SAP BTP Service Binding template for the SaaS Backend Service\nservice.yaml # ClusterIP Service template for the SaaS Backend Service\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Good to know")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Sustainable SaaS Backend Service is using a separate ",(0,r.kt)("strong",{parentName:"p"},"Service Account"),", and the respective Service Account Token is ",(0,r.kt)("strong",{parentName:"p"},"auto-mounted")," (only workload requiring this). In combination with a separate ",(0,r.kt)("strong",{parentName:"p"},"Cluster Role")," (including permissions to manage API Rules) and a respective ",(0,r.kt)("strong",{parentName:"p"},"Role Binding"),", this enables the Backend Service to create ",(0,r.kt)("strong",{parentName:"p"},"API Rules")," for new subscribers at runtime. To learn more, check the ",(0,r.kt)("em",{parentName:"p"},"srv/utils/apiRule.js")," implementation.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Authorization Policy"),' of our Backend Service allows access from the Application Router workloads only by restricting access to the corresponding principal. The only exception are the "*/-/cds/.',"*",'*" paths, which are accessible through Istio Ingress Gateway. This blocks public traffic access except for those dedicated paths. The associated Virtual Service (created by the provided API Rule) only redirects traffic on these specific paths to the Cluster IP Service of the Backend Service workloads. All other requests targeting the Backend Service, have to pass through the Application Router first. ')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Application Router ensures that requests are properly authenticated by XSUAA (and enforces a login if required) and will handle multitenancy. The communication between Application Router and our Backend Service is unrestricted, as the Application Router principal has been added to the respective Authorization Policy. "),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nspec:\n  # Matches any request targeting the SaaS Backend Service workload\n  selector: \n    matchLabels: \n      app.kubernetes.io/name: srv\n  action: ALLOW\n  rules:\n    # Allow Istio Ingress Gateway traffic to access all /-/cds/* paths\n    # Required for dependency callbacks and CDS related requests (e.g., extensions)\n    - to:\n      - operation:\n          paths: \n            - /-/cds/*\n      from: \n        - source:\n            principals:\n              - cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\n    # Grants access to all paths for traffic from Application Router \n    # "ns" in the match pattern is the abbreviation for "Namespace"\n    # "sa" in the match pattern is the abbreviation for "Service Account"\n    - from:\n      - source:\n          principals: \n            - cluster.local/ns/default/sa/susaas-router\n')))))}u.isMDXComponent=!0},41220:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/APIManagementArch-dfeff21931d13dacdb290f1bbed61463.png"},83977:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/KymaObjectsGeneral-21d4e7fc56d23fefdb216545e99a0bc9.png"},84850:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/ResourceDetailsArch-413621d553782d75563c31cf33071cfd.png"}}]);
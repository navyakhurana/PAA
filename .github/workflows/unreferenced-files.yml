name: Cleanup Unreferenced Files

on:
  workflow_dispatch:
    inputs:
      confirm_delete:
        description: "Delete unreferenced files? (true/false)"
        required: true
        default: "false"
  schedule:
    - cron: "0 6 * * 1" # Every Monday 6 AM UTC (Monday morning)

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find unreferenced files
        id: find_unreferenced
        run: |
          echo "Searching for image/docs files not referenced in any README or .md file..."

          # Find all image/docs files (adjust extensions if needed)
          find docs -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.gif" -o -iname "*.svg" \) > all_files.txt

          # Find all markdown content
          grep -r --include="*.md" -o -h 'docs[^") ]\+\.\(png\|jpg\|jpeg\|gif\|svg\)' . | sort | uniq > referenced.txt

          # Find unreferenced files
          grep -Fxv -f referenced.txt all_files.txt > unreferenced.txt || true

          echo "Unreferenced files:"
          cat unreferenced.txt || echo "None found"

          # Output file count
          FILE_COUNT=$(wc -l < unreferenced.txt | tr -d ' ')
          echo "unreferenced_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          # Save to step summary
          {
            echo "## ðŸ§¹ Unreferenced Files Found"
            if [[ $FILE_COUNT -eq 0 ]]; then
              echo "ðŸŽ‰ No unreferenced files found!"
            else
              echo "**$FILE_COUNT** unreferenced files found:"
              echo ''
              cat unreferenced.txt
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Delete unreferenced files
        if: ${{ github.event.inputs.confirm_delete == 'true' }}
        run: |
          echo "Deleting unreferenced files..."
          while read -r file; do
            echo "Deleting $file"
            rm -f "$file"
          done < unreferenced.txt

      - name: Create Pull Request with deleted files
        if: ${{ github.event.inputs.confirm_delete == 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ§¹ Remove unreferenced files"
          title: "ðŸ§¹ Cleanup: Remove unreferenced files"
          body: |
            This PR removes **unreferenced files** (mostly images or assets) not used in any `.md` or `README.md` file.

            Please review before merging.
          branch: cleanup-unused-files-${{ github.run_id }}
          delete-branch: true
          labels: cleanup
          assignees: ${{ github.actor }}
          draft: false
